<!DOCTYPE html>
<meta charset="utf-8">
<style>

.node {
  stroke: #fff;
  stroke-width: 1.5px;
}

.link {
  stroke: #999;
  stroke-opacity: .6;
}

</style>
<body>
  <script src="http://d3js.org/d3.v3.min.js"></script>
  <script src="underscore.js"></script>
  <script>

  var width = window.innerWidth,
  height = window.innerHeight;

  console.log("W: " + width);
  console.log("H: " + height);

  var _graph;


  var color = function(d){
    switch(d){
        //dependency
        case 0: return '#1f77b4';
        break;
        //hierarchy
        case 1: return '#2ca02c';
        break;
      }
    }

    var link_type_color = function(d){
      switch(d){
        case 0: return '#999';
        break;
        case 1: return color(d);
        break;
      }
    }

    var link_type_width = function(d){
      switch(d){
        case 0: return '1px';
        break;
        case 1: return '2px';
        break;
      }
    }

    var node_stroke_width = function(d){
      if(d == 1)
        return "2px";
      else
        return "0px";
    }

    var force = d3.layout.force()
    .charge(-10000)
    .linkDistance(100)
    .friction(0.05)
    .gravity(0.2)
    .linkStrength(0.2)
    .size([width, height]);

    var svg = d3.select("body").append("svg")
    .attr("width", width)
    .attr("height", height);

    var button = svg.append("circle")
    .attr("cx", 30)
    .attr("cy", 30)
    .attr("r", 20)
    .style("fill", "red");


    button.on("mousedown", function() {
      button.style("fill", "blue");
    });

    button.on("mouseup", function() {
      button.style("fill", "red");
    });

    button.on("click", function() {
  // Change graph
  var graph;

  graph = _graph;

  // Redraw graph
  draw(graph);
})

    d3.json("graph.json", function(error, graph) {
      _graph = graph;
      draw(graph);
    });

    function draw (graph) {
      force
      .nodes(graph.nodes)
      .links(graph.links)
      .start();



      var link = svg.selectAll(".link").data(graph.links)
      .style("stroke-width", function(d) { 
        return link_type_width(d.value);
      })
      .style("stroke", function(d) { 
        return link_type_color(d.value);
      });
      link.enter().append("line")
      .attr("class", "link")
      .style("stroke-width", function(d) { 
        return link_type_width(d.value);
      })
      .style("stroke", function(d) { 
        return link_type_color(d.value);
      });
      link.exit().remove();



  // Select + update
  var node = svg.selectAll(".node").data(graph.nodes);                  

  // Enter
  var newNodes = node.enter()                              
  .append("g")
  .classed("node", true)                          
  .style("cursor", "pointer")
  .call(force.drag)
  .each(function(d) {
    var gNodeSel = d3.select(this);

    var rects = gNodeSel.append("rect")
    .attr("class", "node-box");

    // Test
      var texts = gNodeSel.append("text")
              .classed("title-text", true)
              .attr("x",0)
      .attr("y", 20)
      .attr("font-size", 15)
      .attr("text-anchor","middle")
      .attr("font-family", "Helvetica Neue")
      .attr("font-weight", "100")
      .attr("fill", "white")
              .text(function(d) {
                return d.name;
              });

    rects.attr("height", 30)
    .attr("width", function(d){
      god = this;
      return rectWidth(this)      
    })
    .style("fill", function(d) {
      return color(d.group);
    })
    .style("stroke-width", function(d) {
      return node_stroke_width(d.subclass);
    })
    .style("stroke", "#2ca02c")
    .attr("rx", 10)
    .attr("ry", 10)
    .attr("x",function(d){
      return -rectWidth(this) / 2     
    })
    .style("opacity", 0.75);
  });


  // Exit
  node.exit().remove();

  function rectWidth(rect){
    var label = d3.select(rect.parentNode).select(".title-text");
    var bbox = label[0][0].getBBox();
    return bbox.width + 20;
  }

  force.on("tick", function() {
    link.attr("x1", function(d) { return d.source.x; })
    .attr("y1", function(d) { return d.source.y + 30; })
    .attr("x2", function(d) { return d.target.x; })
    .attr("y2", function(d) { return d.target.y; });

    node.attr("transform", function(d){

      return "translate(" + d.x + ", " + d.y + ")" 

    });
  });
}

</script>